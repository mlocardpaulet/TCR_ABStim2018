---
title: "Mapping phosphorylation sites to known sites in the databases"
author: "Marie Locard-Paulet"
date: '`r Sys.Date()`'
output: html_document
---

```{r, echo=F, message=F}
knitr::opts_chunk$set(echo = FALSE)

require(knitr)
require(Biostrings)
require(ggplot2)
require(reshape2)
```


```{r}
load("RData/02_psiteInfo.RData")
```

This document retrieves the information from specific phosphorylation sites databases in order to analyse the label-free MS data sets of phospho-enriched peptides from primary T-cells.

I use the mapping files from [PhosphOrtholog](http://www.phosphortholog.com/), Chadhuri et al. 2015 (10.1186/s12864-015-1820-x). From these, I retrieve the Uniprot IDs of Rat and Human corresponding to the ones I have in my data set.

```{r, eval = F}
MappingHM <- read.table("T:/DB/Mapping/PhosphOrtholog_20170623/Mapping_H_M.csv", sep = " ", header = T)
MappingRM <- read.table("T:/DB/Mapping/PhosphOrtholog_20170623/Mapping_R_M.csv", sep = " ", header = T)
MappingM <- rbind(MappingRM[,c(2,1)], MappingHM[,c(2,1)]) # The mouse ID is in the first column
rm(MappingHM, MappingRM)

# Find the ones I need:
myAcc <- names(psiteInfo)
myAcc <- sapply(myAcc, function(x) {
  strsplit(x, "_", fixed = T)[[1]][1]
})
myAcc <- sapply(myAcc, function(x) {
  strsplit(x, ";", fixed = T)[[1]]
})
myAcc <- unique(unlist(myAcc))

MappingM <- MappingM[MappingM$UniProt.SwissProt.Accession.2 %in% myAcc,]
MappingList <- lapply(as.character(unique(MappingM[,1])), function(x){
  as.character(MappingM[MappingM==x,2])
})
names(MappingList) <- as.character(unique(MappingM[,1]))

save(list = c("MappingList", "MappingM", "myAcc"), file = "RData/DBMapping/MappingPhospho_01.Rdata") # the names are the mouse ID
```

```{r}
load("RData/DBMapping/MappingPhospho_01.Rdata")
```

Protein accessions that are in my data but not in my mapping file:

```{r, echo = F}
myAcc[!(myAcc %in% names(MappingList))]
```

# Retrieve information from PhosphositePlus

I work with the tables downloaded from the [PhosphositePlus website](http://www.phosphosite.org/homeAction.action) the 17th of August 2018:

* `PhosphoSitePlus_20180817/Kinase_Substrate_Dataset` contains the kinase/substrate relationships.
* `PhosphoSitePlus_20180817/Phosphorylation_site_dataset` contains the informations regarding the phosphosites, including their position in the sequence.

I merge the tables based on the substrate sequence window (in upper cases). In order to map kinases and domains to our result table, I use the sequence window to map the phosphosites we identify to the phosphositeplus table.

On top of keeping the kinase/substrate and domains information, I create a column called  `InPsitePlus` that contains "yes" or "no" depending on if this phosphosite has already been references in the database.

```{r, eval = F}
ltabK <- list()
ltabK[[1]] <- read.table("PhosphoSitePlus_20180817/Kinase_Substrate_Dataset", as.is = T, comment.char = "#", sep = "\t", header = T, skip = 3)
ltabK[[2]] <- read.csv("PhosphoSitePlus_20180817/Phosphorylation_site_dataset", as.is = T, comment.char = "#", sep = "\t", header = T, skip = 3)
ltabK[[1]]$SITE_...7_AA <- toupper(ltabK[[1]]$SITE_...7_AA)
ltabK[[2]]$SITE_...7_AA <- toupper(ltabK[[2]]$SITE_...7_AA)
tabK <- merge(ltabK[[1]], ltabK[[2]], by = "SITE_...7_AA", all = T)
SITE_GRP_ID <- as.character(tabK$SITE_GRP_ID.x)
SITE_GRP_ID[is.na(SITE_GRP_ID)] <- as.character(tabK$SITE_GRP_ID.y)[is.na(SITE_GRP_ID)]
tabK$ALL_SITEGPID <- SITE_GRP_ID
save(tabK, file = "RData/DBMapping/PsitePlus.RData")
```

```{r}
load(file = "RData/DBMapping/PsitePlus.RData")
```

```{r}
load("RData/01_ParsedTables.RData")

seq <- sapply(lf, function(x) {
  cbind(x$Sequence.window, x$phosphoSite)
})

source("RFunctions/RBindList.R")

seq <- RBindList(seq)
seq <- seq[!duplicated(seq),]
# Split rows with multiple protein IDs:
temp <- seq[grepl(";", seq[,1]),]
vec1 <- lapply(temp[,1], function(x) {
  strsplit(x, ";", fixed = T)[[1]]
})
vec2 <- sapply(seq_len(nrow(temp)), function(x) {
  rep(temp[x,2],sapply(vec1, length)[x])
})
temp <- cbind(unlist(vec1), unlist(vec2))
temp <- temp[!duplicated(temp),]
seq <- rbind(seq[!grepl(";", seq[,1]),], temp)
colnames(seq) <- c("Window15", "phosphoSites")
# Reduce the sequence length:
vec <- as.character(sapply(seq[,1], substr, 9, 23))
seq <- cbind(seq, "Window7" = vec)
```

```{r}
psiteID <- names(psiteInfo)

Known <- seq[,2][seq[,3] %in% as.character(tabK$SITE_...7_AA)]

PPIDs <- tabK$ALL_SITEGPID[match(seq[,3], as.character(tabK$SITE_...7_AA))]
seq <- data.frame(seq, "PhosphoPlusIDs" = PPIDs)
seq <- seq[!is.na(as.character(seq$Window15)),]
mapped <- unique(seq$phosphoSites[!is.na(seq$PhosphoPlusIDs)])
notmapped <- unique(seq$phosphoSites[is.na(seq$PhosphoPlusIDs)])
```

There are `r length(mapped)` phosphorylation sites of our data set mapped to PhosphositePlus IDs due to exact identical sequence. Using this simple matching approach, `r length(notmapped)` of the phosphorylation sites of the data set are not mapped to PhosphositePlus IDs. This can be explained by the absence of the phosphorylation site from PhosphositePlus data base or because it is referenced with a slightly dissimilar sequence due to the fact that it has been observed in an other species (not mouse - so dissimilar sequence). In total, we have `r length(unique(as.character(seq$phosphoSites)))` phosphorylation sites in our data set.

In order to gain information from these sites, I look for similar sequences using the "pairwiseAlignment()" function. 

```{r, echo = F, eval = F}
# I need to do it in a different way, performing the pairwise alignment on the entire protein sequence in order to avoid mapping similar sequences at different parts of the protein.
seq2 <- seq[seq$phosphoSites %in% notmapped,]

vec <- sapply(seq2$phosphoSites, function(x) {
  strsplit(as.character(x), "_", fixed = T)[[1]][1]
})
seq2$Accession <- vec

l <- list(); lOrga <- list()
for (i in 1:nrow(seq2)) {
        vari <- as.character(seq2$Window7[i])
        acc <- as.character(seq2$Accession[i])
        if (!grepl(";", acc)) {
          acc2 <- c(acc, unlist(MappingList[names(MappingList)==acc]))
        } else {
          acc2 <- unlist(sapply(acc, strsplit, ";", fixed = T))
          acc2 <- c(acc2, unlist(MappingList[names(MappingList) %in% acc2]))
        }
        temp <- tabK[(tabK$SUB_ACC_ID %in% acc2 | tabK$ACC_ID %in% acc2),]
        temp$AllOrga <- temp$ORGANISM
        temp$AllOrga[is.na(temp$AllOrga)] <- temp$SUB_ORGANISM[is.na(temp$AllOrga)]
        if (nrow(temp)>0) {
                vari2 <- gsub("_", "", temp$SITE_...7_AA)
                vari <- gsub("_", "", vari)
                matchList <- lapply(vari2, function(x){
                  pairwiseAlignment(AAString(vari), AAString(x), substitutionMatrix = "BLOSUM50", gapOpening = 10, gapExtension = 10, scoreOnly == FALSE)
                  })
                scores <- sapply(matchList, score)
                IDs <- temp$ALL_SITEGPID[scores>50 & substr(vari, 8,8) == substr(vari2, 8, 8)]
                Species <- temp$AllOrga[scores>50 & substr(vari, 8,8) == substr(vari2, 8, 8)]
        }
        if (!(class(IDs) == "character" & length(IDs) == 0)) {
          l[[length(l)+1]] <- IDs
          names(l)[[length(l)]] <- as.character(seq2$phosphoSites)[i]
          lOrga[[length(lOrga)+1]] <- Species
          names(lOrga)[[length(lOrga)]] <- as.character(seq2$phosphoSites)[i]
        }
}

save(list = c("seq", "seq2", "l", "lOrga"), file = "RData/DBMapping/MappingPhospho_02.Rdata")
```

```{r, echo = F}
load("RData/DBMapping/MappingPhospho_02.Rdata")
```

On the `r nrow(seq2)` phosphorylation sites of the query, `r length(l)` have sequence matches.

```{r, echo = F}
n <- sapply(l, function(x){length(unique(x))})
```

There are `r length(l[n>1])` cases where several sequences of the same organism match the input sequence window: `r sort(names(l[n>1]))`. I manually check these in PhosphositePlus.

```{r}
ManualInput <- read.table("RData/DBMapping/ManualMapping.txt", sep = "\t", header = T, stringsAsFactors = F)
```

I manually add these in our data sets.

```{r}
for (i in seq_len(nrow(ManualInput))) {
  l[[length(l)+1]] <- ManualInput[i,2]
  names(l)[length(l)] <- ManualInput[i,1]
}
rm(seq2)

seq$PhosphoPlusIDs <- as.character(seq$PhosphoPlusIDs)
for (i in seq_along(l)) {
  seq$PhosphoPlusIDs[seq$phosphoSites == names(l)[i]] <- paste(unique(l[[i]]), collapse = "|")
}

IsMapped <- unique(seq$phosphoSites[!is.na(seq$PhosphoPlusIDs)])
NotMapped <- unique(seq$phosphoSites[is.na(seq$PhosphoPlusIDs)])
```

I map back PhosphositePlus IDs and informations to annotated tables.

```{r, eval = F}
vec <- paste0(tabK$ACC_ID, "_", gsub("-p", "", tabK$MOD_RSD, fixed = T))
vec[vec == "NA_NA"] <- paste0(tabK$SUB_ACC_ID[vec == "NA_NA"], "_", tabK$SUB_MOD_RSD[vec == "NA_NA"])
tabKM <- tabK[tabK$ORGANISM == "mouse",]
vecM <- vec[tabK$ORGANISM == "mouse"]
  
for (i in seq_along(psiteInfo)) {
  li <- psiteInfo[[i]]
  if (is.null(tabKM$ALL_SITEGPID[match(li$MonoSites, vecM)])) {
    li$PhosphoSitePlusMouse <- NA
  } else {
    li$PhosphoSitePlusMouse <- tabKM$ALL_SITEGPID[match(li$MonoSites, vecM)]
  }
  if (is.null(seq$PhosphoPlusIDs[match(li$MonoSites, seq$phosphoSites)])) {
    li$PhosphoSitePlusAll <- NA
  } else {
    li$PhosphoSitePlusAll <- seq$PhosphoPlusIDs[match(li$MonoSites, seq$phosphoSites)]
  }
  psiteInfo[[i]] <- li
}
  
save(psiteInfo, file = "RData/03_psiteInfoPhosphoSitePlus.RData")
```

```{r}
load(file = "RData/03_psiteInfoPhosphoSitePlus.RData")
```

```{r, eval = F}
for (i in seq_along(lf)) {
  tab <- lf[[i]]
  tab$PSPAllSPecies <- sapply(tab$phosphoSites, function(x) {
    psiteInfo[[which(names(psiteInfo) == x)]]$PhosphoSitePlusAll
  })
  tab$PSPMouse <- sapply(tab$phosphoSites, function(x) {
    psiteInfo[[which(names(psiteInfo) == x)]]$PhosphoSitePlusMouse
  })
  lf[[i]] <- tab
}
  
save(lf, file = "RData/04_ParsedTablesPSP.RData")
```

```{r}
load(file = "RData/04_ParsedTablesPSP.RData")
```

```{r}
vec <- sapply(psiteInfo, function(x) {x$PhosphoSitePlusAll})
notmapped <- names(vec)[is.na(vec)]
mapped <- names(vec)[!is.na(vec)]

vec <- sapply(psiteInfo[names(psiteInfo) %in% notmapped], function(x) {x$GeneID})
vec <- as.character(vec)
vec <- vec[grepl("_Y", vec, fixed = T)]
```

There are `r length(mapped)` and `r length(notmapped)` phosphorylation sites in our data set that are reported in phosphositePlus and not reported, respectively.

 sites from the pY-IP are not referenced in PhosphoSitePlus:
`r sort(vec)`.

```{r}
sessionInfo()
```