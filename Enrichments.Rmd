---
title: "TCR phospho-signalling upon antibody-based stimulation"
author: "Marie Locard-Paulet"
date: '`r date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(venneuler)
library(reshape2)
library(ggplot2)
library(gplots)
library(knitr)
library(corrplot)
```

Results of enrichment analysis.

`"KEAEnrichments"` contains the results of phosphorylation site specific enrichment using [KEA](http://www.maayanlab.net/KEA2/#) the 4th September 2018 (no background). I saved the enrichment results with the following labels:
- "KS" for Literature Based Kinase-Substrate Library with Phosphosites, followed by the cluster number.
- "BT" for Biological Terms Associated with Phosphosites from Literature Mining, followed by the cluster number.
- "AllReg" is when I used all the regulated sites as input.
- "Background" is when I used all the sites identified in the data set.

`"PANTHER"` contains the results of GO term enrichments based on the gene names using [Panther](http://pantherdb.org/) the 4th September 2018. I used the detected sites as background.

`"Phomics"` contains the results of GO term enrichments based on the phosphorylation sites using [Phomics](http://phomics.jensenlab.org/phospho_enrichment_uniprot) the 4th September 2018. I used the detected sites as background.

*The gene list used for the background is in the PANTHER folder.*

--------------------------------------------------------------------------------

# Phomics

```{r}
lfiles <- list.files(path = "Phomics/", pattern = ".txt", full.names = T)
ltab <- lapply(lfiles, read.table, sep = "\t", header = T)
names(ltab) <- list.files(path = "Phomics/", pattern = ".txt", full.names = F)
names(ltab) <- gsub("Phomics_", "", names(ltab), fixed = T)
names(ltab) <- gsub("UsingBG.txt", "", names(ltab), fixed = T)
```

```{r}
source("RFunctions/RBindList.R")
for (i in seq_along(ltab)) {
  tit <- names(ltab)[i]
  tab <- ltab[[i]]
  tab$Cluster <- rep(tit, nrow(tab))
  # g <- ggplot(tab, aes(x = -log10(enrichment.ratio), y = -log10(p.value), label = Source, col = ID)) + geom_text() + ggtitle(tit)
  # print(g)
  ltab[[i]] <- tab
}
phomics <- RBindList(ltab)
phomics$Source <- as.character(phomics$Source)
phomics <- phomics[phomics$ID == "Biological Process",]
phomics <- phomics[!duplicated(phomics),]
phomics <- phomics[!is.na(phomics$Source),]

# Order for the heatmap:
mat <- dcast(phomics, formula = Source~Cluster, value.var = "Description")
na <- mat[,1]
mat <- as.matrix(mat[,2:ncol(mat)])
mat[is.na(mat)] <- 0
ord <- hclust(dist(mat, method = "euclidean"), method = "ward.D" )$order
names(ord) <- na
phomics$Source <- factor(phomics$Source, levels = names(ord)[ord])

g <- ggplot(phomics[phomics$ID == "Biological Process",], aes(y = Source, x = Cluster)) + geom_tile(aes(fill = Description), colour = "white") + scale_fill_gradient(low = "orange", high = "darkred") + theme_minimal()
print(g)
```


# KEA

```{r}
lfiles <- list.files(path = "KEAEnrichments/Enrichments_20180904/", pattern = ".txt", full.names = T)
ltab <- lapply(lfiles, readLines)
ltab <- lapply(ltab, function(x) {
  gsub(",\t", ", ", x)
})
ltab <- lapply(ltab, function(x) {
  strsplit(x, "\t")
})
names(ltab) <- list.files(path = "KEAEnrichments/Enrichments_20180904/", pattern = ".txt", full.names = F)
names(ltab) <- gsub("enrichment_results_", "", names(ltab), fixed = T)
names(ltab) <- gsub(".txt", "", names(ltab), fixed = T)
ltab <- lapply(ltab, RBindList)
```

I keep only the hits with more than 3 sites and remove the hits enriched in the background.

```{r}
for (i in seq_along(ltab)) {
  tit <- names(ltab)[i]
  tab <- as.data.frame(ltab[[i]][2:nrow(ltab[[i]]),])
  names(tab) <- ltab[[i]][1,]
  tab$Cluster <- rep(tit, nrow(tab))
  tab$`Original P-Value` <- as.numeric(as.character(tab$`Original P-Value`))
  tab$`Total Genes in Gene Set` <- as.numeric(as.character(tab$`Total Genes in Gene Set`))
  g <- ggplot(tab, aes(y = -log10(`Original P-Value`), x = `Total Genes Intersected`, label = `Node Name`, col = `Total Genes in Gene Set`)) + geom_text() + ggtitle(tit) + scale_colour_gradient(low = "orange", high = "darkred") + theme_bw()
  print(g)
  ltab[[i]] <- tab
}
KEA <- RBindList(ltab)
KEA <- KEA[!is.na(KEA$`Node Name`),]
KEA <- KEA[as.numeric(as.character(KEA$`Total Genes Intersected`)) >= 3,]
rm <- as.character(KEA$`Node Name`[KEA$Cluster %in% c("BTBackground", "KSBackground")])
KEA <- KEA[!(KEA$`Node Name` %in% rm),]

matKEA <- dcast(KEA, formula = `Node Name`~Cluster, value.var = "Corrected P-Value with Bonferroni")
na <- matKEA[,1]
matKEA <- as.matrix(matKEA[,2:ncol(matKEA)])
matKEA[is.na(matKEA)] <- 0


KEA$Type <- sapply(KEA$Cluster, function(x) {
  substr(x, 1, 2)
})
KEA$Cluster <- sapply(KEA$Cluster, function(x) {
  substr(x, 3, 15)
})
KEA$`Corrected P-value with Benjamini-Hochberg` <- as.numeric(as.character(KEA$`Corrected P-value with Benjamini-Hochberg`))


# Order for the heatmap:
mat <- matKEA[, grepl("BT", colnames(matKEA))]
ordBT <- hclust(dist(mat, method = "euclidean"), method = "ward.D" )$order
names(ordBT) <- na
mat <- matKEA[, grepl("KS", colnames(matKEA))]
ordKS <- hclust(dist(mat, method = "euclidean"), method = "ward.D" )$order
names(ordKS) <- na

KEA$`Node Name` <- factor(KEA$`Node Name`, levels = names(ordBT)[ordBT])

g <- ggplot(KEA[KEA$Type == "BT",], aes(y = `Node Name`, x = Cluster)) + geom_tile(aes(fill = -log10(`Corrected P-value with Benjamini-Hochberg`)), colour = "white") + scale_fill_gradient(low = "orange", high = "darkred") + theme_minimal() + ggtitle("Biological terms from KEA") + theme(axis.text.y = element_text(size = 5)) 
print(g)

KEA$`Node Name` <- factor(KEA$`Node Name`, levels = names(ordKS)[ordKS])
g <- ggplot(KEA[KEA$Type == "KS",], aes(y = `Node Name`, x = Cluster)) + geom_tile(aes(fill = -log10(`Corrected P-value with Benjamini-Hochberg`)), colour = "white") + scale_fill_gradient(low = "orange", high = "darkred") + theme_minimal() + ggtitle("Kinase-Substrates from KEA")
print(g)
```

# GO term enrichments with Panther

```{r}
lfiles <- list.files(path = "PANTHER/Output_20180904/", pattern = ".txt", full.names = T)
ltab <- lapply(lfiles, read.table, sep = "\t", header = T, skip = 10)
names(ltab) <- list.files(path = "PANTHER/Output_20180904/", pattern = ".txt", full.names = F)
names(ltab) <- gsub("Panther_", "", names(ltab), fixed = T)
names(ltab) <- gsub("UsingBG.txt", "", names(ltab), fixed = T)
```

```{r}
for (i in seq_along(ltab)) {
  tit <- names(ltab)[i]
  tab <- as.data.frame(ltab[[i]])
  tab$Cluster <- rep(tit, nrow(tab))
  tab$Client.Text.Box.Input..FDR. <- as.numeric(as.character(tab$Client.Text.Box.Input..FDR.))
  tab$Client.Text.Box.Input..fold.Enrichment. <- as.numeric(as.character(tab$Client.Text.Box.Input..fold.Enrichment.))
  names(tab)[1] <- "Name"
  g <- ggplot(tab, aes(y = -log10(Client.Text.Box.Input..FDR.), x = Client.Text.Box.Input..fold.Enrichment., label = Name)) + geom_text() + ggtitle(tit) + theme_bw()
  print(g)
  ltab[[i]] <- tab
}
```

--------------------------------------------------------------------------------

```{r}
sessionInfo()
```